<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n LÃ½ CÃ´ng Viá»‡c</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1>Há»‡ Thá»‘ng Quáº£n LÃ½ CÃ´ng Viá»‡c</h1>

    <h2>ğŸ”‘ ÄÄƒng Nháº­p</h2>
    <input type="text" id="username" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p">
    <input type="password" id="password" placeholder="Nháº­p máº­t kháº©u">
    <button onclick="login()">ÄÄƒng Nháº­p</button>
    <p id="loginStatus"></p>

    <h2>âœ… ThÃ´ng Tin NgÆ°á»i DÃ¹ng</h2>
    <p id="userInfo"></p>

    <h2>ğŸ“Œ Táº¡o CÃ´ng Viá»‡c</h2>
    <input type="text" id="jobName" placeholder="TÃªn cÃ´ng viá»‡c">
    <input type="date" id="deadline">
    <button onclick="createJob()">Táº¡o Job</button>
    <p id="jobStatus"></p>

    <h2>ğŸ“Œ Danh SÃ¡ch CÃ´ng Viá»‡c Cá»§a TÃ´i</h2>
    <button onclick="getMyJobs()">Xem CÃ´ng Viá»‡c</button>
    <ul id="myJobsList"></ul>

    <h2>ğŸ“Œ Cáº­p Nháº­t Tráº¡ng ThÃ¡i Job</h2>
    <input type="number" id="updateJobId" placeholder="ID Job">
    <select id="updateStatus">
        <option value="IN_PROGRESS">Äang thá»±c hiá»‡n</option>
        <option value="COMPLETED">HoÃ n thÃ nh</option>
        <option value="OVERDUE">QuÃ¡ háº¡n</option>
    </select>
    <button onclick="updateJobStatus()">Cáº­p Nháº­t</button>

    <h2>ğŸ“Š Biá»ƒu Äá»“ CÃ´ng Viá»‡c</h2>
    <canvas id="jobChart"></canvas>
    <button onclick="getJobStats()">Xem Thá»‘ng KÃª</button>

    <script>
        const API_URL = "http://localhost:8080/user";

        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            
            const response = await fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const user = await response.json(); // Tráº£ vá» userId, username
                localStorage.setItem("userId", user.userId); // LÆ°u userId vÃ o trÃ¬nh duyá»‡t
                localStorage.setItem("username", user.username);
                document.getElementById("loginStatus").innerText = `ÄÄƒng nháº­p thÃ nh cÃ´ng! ID: ${user.userId}`;
                document.getElementById("userInfo").innerText = `NgÆ°á»i dÃ¹ng: ${user.username} (ID: ${user.userId})`;
            } else {
                document.getElementById("loginStatus").innerText = "Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u!";
            }
        }

        async function createJob() {
            const jobName = document.getElementById("jobName").value;
            const deadline = document.getElementById("deadline").value;
            const userId = localStorage.getItem("userId");

            if (!userId) {
                alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c!");
                return;
            }

            const response = await fetch(`${API_URL}/createJob?jobName=${jobName}&deadline=${deadline}&createdUserId=${userId}&executedUserId=${userId}`, {
                method: "POST"
            });

            const data = await response.json();
            document.getElementById("jobStatus").innerText = data.jobId ? `Táº¡o Job thÃ nh cÃ´ng! ID: ${data.jobId}` : `Lá»—i: ${data}`;
        }

        async function getMyJobs() {
            const userId = localStorage.getItem("userId");
            if (!userId) {
                alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c!");
                return;
            }

            const response = await fetch(`${API_URL}/my-jobs?executedId=${userId}`);
            const jobs = await response.json();

            const list = document.getElementById("myJobsList");
            list.innerHTML = "";
            jobs.forEach(job => {
                const li = document.createElement("li");
                li.textContent = `${job.jobName} - ${job.status}`;
                list.appendChild(li);
            });
        }

        async function updateJobStatus() {
            const jobId = document.getElementById("updateJobId").value;
            const userId = localStorage.getItem("userId");
            const newStatus = document.getElementById("updateStatus").value;

            if (!userId) {
                alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c!");
                return;
            }

            await fetch(`${API_URL}/update-status?jobId=${jobId}&userId=${userId}&newStatus=${newStatus}`, { method: "PUT" });
            alert("Cáº­p nháº­t thÃ nh cÃ´ng!");
        }

        async function getJobStats() {
            const userId = localStorage.getItem("userId");
            if (!userId) {
                alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c!");
                return;
            }

            const response = await fetch(`${API_URL}/count-by-status?approverId=${userId}`);
            const stats = await response.json();

            const labels = Object.keys(stats);
            const data = Object.values(stats);

            new Chart(document.getElementById("jobChart"), {
                type: "pie",
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: ["red", "blue", "green", "orange", "purple"] }]
                }
            });
        }

        // Hiá»ƒn thá»‹ thÃ´ng tin Ä‘Äƒng nháº­p sau khi táº£i láº¡i trang
        window.onload = function() {
            const userId = localStorage.getItem("userId");
            const username = localStorage.getItem("username");
            if (userId) {
                document.getElementById("loginStatus").innerText = `ÄÄƒng nháº­p thÃ nh cÃ´ng! ID: ${userId}`;
                document.getElementById("userInfo").innerText = `NgÆ°á»i dÃ¹ng: ${username} (ID: ${userId})`;
            }
        };
    </script>

</body>
</html>
